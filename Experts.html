/ experts.js
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js";
import { app } from './firebase-config.js';

const database = getDatabase(app);
const expertsRef = ref(database, 'experts');
const expertsContainer = document.getElementById('experts-list');
const searchInput = document.getElementById('searchInput');

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Display loading state
function showLoading() {
    expertsContainer.innerHTML = '<div class="loading">Loading experts...</div>';
}

// Display error state
function showError(message) {
    expertsContainer.innerHTML = `<div class="error">Error: ${message}</div>`;
}

// Create expert card HTML
function createExpertCard(expert) {
    return `
        <div class="expert-card">
            <h3>${expert.fullName}</h3>
            <p><strong>Specialization:</strong> ${expert.specialization}</p>
            <p><strong>Experience:</strong> ${expert.experience}</p>
            <p><strong>Certifications:</strong> ${expert.certifications}</p>
            <p><strong>Key Skills:</strong> ${expert.keySkills}</p>
            <p><strong>Projects:</strong> ${expert.projects}</p>
        </div>
    `;
}

// Filter experts based on search term
function filterExperts(experts, searchTerm) {
    return Object.values(experts).filter(expert => {
        const searchFields = [
            expert.fullName,
            expert.specialization,
            expert.keySkills
        ].map(field => field.toLowerCase());
        
        return searchFields.some(field => field.includes(searchTerm));
    });
}

// Initialize experts list
function initExperts() {
    showLoading();

    onValue(expertsRef, (snapshot) => {
        const experts = snapshot.val();
        
        if (experts) {
            const expertsList = Object.values(experts)
                .map(expert => createExpertCard(expert))
                .join('');
            expertsContainer.innerHTML = expertsList;
        } else {
            expertsContainer.innerHTML = '<p>No experts available at the moment.</p>';
        }
    }, (error) => {
        showError('Failed to load experts. Please try again later.');
        console.error('Firebase error:', error);
    });

    // Setup search with debouncing
    searchInput.addEventListener('input', debounce(function() {
        const searchTerm = this.value.toLowerCase();
        
        onValue(expertsRef, (snapshot) => {
            const experts = snapshot.val();
            if (experts) {
                const filteredExperts = filterExperts(experts, searchTerm);
                expertsContainer.innerHTML = filteredExperts.length > 0
                    ? filteredExperts.map(expert => createExpertCard(expert)).join('')
                    : '<p>No experts found matching your search.</p>';
            }
        });
    }, 300));
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initExperts);
